# 🚀 导入数据到生产环境 - 完整指南

## ✅ 问题已修复

之前遇到的 `error: unknown option '--path'` 错误已经修复！

所有脚本和文档都已更新为正确的命令格式。

---

## 📋 快速开始

### 推荐方式：使用交互式向导

```bash
pnpm db:deploy
```

这个命令会：

1. 📁 列出所有可用的数据文件供你选择
2. 👁️ 让你预览数据内容
3. 🔐 检查 Convex 登录状态
4. 💾 提示并帮助你备份生产环境
5. ⚠️ 多次确认以防误操作
6. ✅ 执行导入并显示结果

---

## 🎯 三种导入方式

### 1️⃣ 交互式向导（最安全，推荐首次使用）

```bash
pnpm db:deploy
```

**优点**：

- 全程引导，不会遗漏任何步骤
- 自动备份生产环境
- 可以预览数据
- 多重安全确认

---

### 2️⃣ 快速导入（适合熟悉流程的用户）

```bash
# 使用默认的 data-export.zip 文件
pnpm db:import:prod
```

或指定文件：

```bash
node scripts/import-data.cjs backup/database/dev-export-20260123-224051.zip --prod
```

**特点**：

- 5 秒确认时间
- 快速执行
- 清晰的输出信息

---

### 3️⃣ Convex CLI（高级用户）

```bash
npx convex import backup/database/dev-export-20260123-224051.zip --prod
```

**特点**：

- 完全控制
- 无额外提示
- 适合脚本化

---

## ⚠️ 重要提示

### 导入前必做的事

1. **备份生产环境数据**（最重要！）

   ```bash
   npx convex export --path backup/database/prod-backup-$(date +%Y%m%d).zip --prod
   ```

2. **验证要导入的数据**

   ```bash
   # 查看文件内容
   unzip -l backup/database/dev-export-20260123-224051.zip

   # 查看记录数
   unzip -p backup/database/dev-export-20260123-224051.zip partners/documents.zip | wc -l
   ```

3. **确认有正确的权限**

   ```bash
   # 登录 Convex
   npx convex login

   # 检查登录状态
   npx convex whoami
   ```

### 导入注意事项

- ❗ 导入会**完全替换**生产环境的所有数据
- ❗ 导入操作**不可撤销**（除非有备份）
- ❗ 选择在**低流量时段**执行
- ❗ 导入前**通知团队成员**

---

## 📊 当前数据状态

**已导出的开发数据**：

- 文件：`backup/database/dev-export-20260123-224051.zip`
- 大小：6.13 KB
- 内容：partners 表（7 条记录）

---

## 🔄 完整导入流程示例

### 方式 A：使用交互式向导（最简单）

```bash
pnpm db:deploy
```

然后按照屏幕提示操作即可。

---

### 方式 B：手动执行（完全控制）

```bash
# 步骤 1: 登录 Convex
npx convex login

# 步骤 2: 备份生产环境
npx convex export --path backup/database/prod-backup-$(date +%Y%m%d-%H%M%S).zip --prod

# 步骤 3: 查看要导入的数据
ls -lh backup/database/
unzip -l backup/database/dev-export-20260123-224051.zip

# 步骤 4: 执行导入（会有 5 秒确认时间）
pnpm db:import:prod

# 步骤 5: 验证导入结果
# 访问 https://dashboard.convex.dev 检查数据
```

---

## ✅ 验证导入结果

### 在 Convex Dashboard 验证

1. 访问 https://dashboard.convex.dev
2. 选择你的生产部署
3. 点击 "Data" 标签
4. 检查 `partners` 表
5. 确认有 7 条记录
6. 抽查几条数据确认内容正确

### 使用扩展程序验证

1. 重新加载生产版扩展程序
2. 打开 popup 界面
3. 检查 partners 列表是否正确显示
4. 测试添加/删除地址等功能

### 使用命令行验证

```bash
# 导出并检查
npx convex export --path verify.zip --prod
unzip -p verify.zip partners/documents.zip | jq . | head -20
rm verify.zip
```

---

## 🔙 回滚（如果需要）

如果导入后发现问题，立即使用备份恢复：

```bash
# 找到之前的备份文件
ls -lh backup/database/prod-backup-*.zip

# 导入备份（替换为实际的备份文件名）
npx convex import backup/database/prod-backup-20260123.zip --prod
```

---

## ❓ 常见问题

### Q: 为什么之前显示 "unknown option '--path'" 错误？

A: Convex CLI 的导入命令格式已更新，路径应作为位置参数而不是 `--path` 选项。我们已经修复了所有脚本。

**错误**: `npx convex import --path file.zip --prod`  
**正确**: `npx convex import file.zip --prod`

### Q: 导入需要多长时间？

A: 取决于数据量。当前数据很小（6.13 KB），通常几秒钟就能完成。

### Q: 可以取消导入吗？

A: 使用 `pnpm db:import:prod` 时有 5 秒确认时间，可以按 `Ctrl+C` 取消。一旦开始导入就无法中断。

### Q: 导入失败了怎么办？

A: 查看错误信息，常见问题：

- 未登录：`npx convex login`
- 网络问题：检查网络连接
- 文件损坏：重新导出数据
- 权限问题：确认有生产环境访问权限

### Q: 可以只导入特定表吗？

A: Convex 的 `import` 命令会导入文件中的所有表。如需只导入特定表，需要：

1. 解压 .zip 文件
2. 删除不需要的表目录
3. 重新压缩
4. 导入修改后的文件

或使用 `--table` 选项导入单个表的 JSON 文件。

---

## 📚 详细文档

- 📘 [完整导入步骤](./docs/PRODUCTION_IMPORT_GUIDE.md)
- 📗 [快速参考](./docs/QUICK_START.md)
- 📙 [数据库迁移指南](./docs/database-migration.md)
- 📕 [导出总结](./docs/EXPORT_SUMMARY.md)
- 📔 [更新日志](./docs/CHANGELOG.md)

---

## 🎯 现在就开始

最简单的方式，运行：

```bash
pnpm db:deploy
```

按照提示操作，几分钟内就能完成生产环境的数据导入！

---

## 需要帮助？

- Convex 官方文档: https://docs.convex.dev/database/import-export
- Convex Discord: https://convex.dev/community
- 查看项目文档: `docs/` 目录
